 ---
title: "EMSI Examples for LANDSAT 5,7,8 & Sentinel-2"
author: "Tyson Lee Swetnam"
date: "September 16, 2018"
output:
  pdf_document: default
  html_document: default
always_allow_html: yes
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Import packages

If you havent run the script before, you may need to install some dependencies and packages. The following code block is commented out, remove # and run.

```{r message=FALSE, warning=FALSE}
# Uncomment the following lines to update and install missing packages

# update.packages(checkBuilt = TRUE, ask=FALSE)
# install.packages("PerformanceAnalytics", dependencies=TRUE)
# install.packages("lubridate", dependencies=TRUE)
# install.packages("dlm", dependencies=TRUE)
# library(devtools)
# install.packages("scales", dependencies=TRUE)
# devtools::install_github('hadley/ggplot2', dependencies=TRUE)
# install_github('sinhrks/ggfortify', dependencies=TRUE)
# install.packages("foreign", dependencies=TRUE)
# install.packages("truncreg", dependencies=TRUE)
# install.packages("boot", dependencies=TRUE)
# install.packages("plotly", dependencies=TRUE)
```

## Load Packages

```{r message=FALSE, warning=FALSE}
library(PerformanceAnalytics)
library(ggplot2)
library(lubridate)
library(plotly)
```

## Import Data

I extracted the entire time series of 16-day Landsat 5,7,8 and 5-day Sentinel-2 NDVI data from Google Earth Engine (GEE) using a 90m reduction. I chose the larger sample area over the point observation of an indvidual pixel to gain more confidence variation over time. 

Even with these filters turned on there are some scenes with snow or cloud contaminated pixels.

```{r message=FALSE, warning=FALSE}
## Import Landsat 5,7,8 16-day and Sentinel-2 5 day NDVI from Google Earth Engine extracted CSVs

## Okavango Shrubland
aoi1 <- read.csv("~/emsi/data/examples/l5-okavango-shrubland-ndvi.csv")
names(aoi1) <- c("date", "ndvi")
aoi2 <- read.csv("~/emsi/data/examples/l7-okavango-shrubland-ndvi.csv")
names(aoi2) <- c("date", "ndvi")
aoi3 <- read.csv("~/emsi/data/examples/l8-okavango-shrubland-ndvi.csv")
names(aoi3) <- c("date", "ndvi")
aoi4 <- read.csv("~/emsi/data/examples/s2-okavango-shrubland-ndvi.csv")
names(aoi4) <- c("date", "ndvi")

all1 <- rbind(aoi1,aoi2,aoi3,aoi4)

## Okavango Swamp
aoi5 <- read.csv("~/emsi/data/examples/l5-okavango-swamp-ndvi.csv")
names(aoi5) <- c("date", "ndvi")
aoi6 <- read.csv("~/emsi/data/examples/l7-okavango-swamp-ndvi.csv")
names(aoi6) <- c("date", "ndvi")
aoi7 <- read.csv("~/emsi/data/examples/l8-okavanog-swamp-ndvi.csv")
names(aoi7) <- c("date", "ndvi")
aoi8 <- read.csv("~/emsi/data/examples/s2-okavango-swamp-ndvi.csv")
names(aoi8) <- c("date", "ndvi")

all2 <- rbind(aoi5,aoi6,aoi7,aoi8)
```

# Calculate Julian dates from calendar

## Okavango Shrubland

```{r message=FALSE, warning=FALSE}
# Landsat 5 Okavango Shrubland
aoi1$ndvi_nans <- as.numeric(as.character(aoi1$ndvi))
aoi1$ndvi_range <- ifelse(aoi1$ndvi_nans>0.05,aoi1$ndvi_nans,NA)
## Convert the dates to an R readable format
aoi1$asdate <- as.Date(aoi1$date, format = "%b %d, %Y")
aoi1$julian <- yday(aoi1$asdate)
aoi1$julian_rounded <- round((aoi1$julian/365)*52)*7

# Landsat 7 Okavango Shrubland
aoi2$ndvi_nans <- as.numeric(as.character(aoi2$ndvi))
aoi2$ndvi_range <- ifelse(aoi2$ndvi_nans>0.05,aoi2$ndvi_nans,NA)
## Convert the dates to an R readable format
aoi2$asdate <- as.Date(aoi2$date, format = "%b %d, %Y")
aoi2$julian <- yday(aoi2$asdate)
aoi2$julian_rounded <- round((aoi2$julian/365)*52)*7

# Landsat 8 Okavango Shrubland
aoi3$ndvi_nans <- as.numeric(as.character(aoi3$ndvi))
aoi3$ndvi_range <- ifelse(aoi3$ndvi_nans>0.05,aoi3$ndvi_nans,NA)
## Convert the dates to an R readable format
aoi3$asdate <- as.Date(aoi3$date, format = "%b %d, %Y")
aoi3$julian <- yday(aoi3$asdate)
aoi3$julian_rounded <- round((aoi3$julian/365)*52)*7

# Sentinel-2 Okavango Shrubland
aoi4$ndvi_nans <- as.numeric(as.character(aoi4$ndvi))
aoi4$ndvi_range <- ifelse(aoi4$ndvi_nans>0.05,aoi4$ndvi_nans,NA)
## Convert the dates to an R readable format
aoi4$asdate <- as.Date(aoi4$date, format = "%b %d, %Y")
aoi4$julian <- yday(aoi4$asdate)
aoi4$julian_rounded <- round((aoi4$julian/365)*52)*7

# All Okavango Shrubland
all1$ndvi_nans <- as.numeric(as.character(all1$ndvi))
all1$ndvi_range <- ifelse(all1$ndvi_nans>0.05,all1$ndvi_nans,NA)
## Convert the dates to an R readable format
all1$asdate <- as.Date(all1$date, format = "%b %d, %Y")
all1$julian <- yday(all1$asdate)
all1$julian_rounded <- round((all1$julian/365)*52)*7
```

## Okavango Swamp

```{r message=FALSE, warning=FALSE}
# Landsat 5 okavango swamp
aoi5$ndvi_nans <- as.numeric(as.character(aoi5$ndvi))
aoi5$ndvi_range <- ifelse(aoi5$ndvi_nans>0.05,aoi5$ndvi_nans,NA)
## Convert the dates to an R readable format
aoi5$asdate <- as.Date(aoi5$date, format = "%b %d, %Y")
aoi5$julian <- yday(aoi5$asdate)
aoi5$julian_rounded <- round((aoi5$julian/365)*52)*7

# Landsat 7 okavango swamp
aoi6$ndvi_nans <- as.numeric(as.character(aoi6$ndvi))
aoi6$ndvi_range <- ifelse(aoi6$ndvi_nans>0.05,aoi6$ndvi_nans,NA)
## Convert the dates to an R readable format
aoi6$asdate <- as.Date(aoi6$date, format = "%b %d, %Y")
aoi6$julian <- yday(aoi6$asdate)
aoi6$julian_rounded <- round((aoi6$julian/365)*52)*7

# Landsat 8 okavango swamp
aoi7$ndvi_nans <- as.numeric(as.character(aoi7$ndvi))
aoi7$ndvi_range <- ifelse(aoi7$ndvi_nans>0.05,aoi7$ndvi_nans,NA)
## Convert the dates to an R readable format
aoi7$asdate <- as.Date(aoi7$date, format = "%b %d, %Y")
aoi7$julian <- yday(aoi7$asdate)
aoi7$julian_rounded <- round((aoi7$julian/365)*52)*7

# Sentinel-2 okavango swamp
aoi8$ndvi_nans <- as.numeric(as.character(aoi8$ndvi))
aoi8$ndvi_range <- ifelse(aoi8$ndvi_nans>0.05,aoi8$ndvi_nans,NA)
## Convert the dates to an R readable format
aoi8$asdate <- as.Date(aoi8$date, format = "%b %d, %Y")
aoi8$julian <- yday(aoi8$asdate)
aoi8$julian_rounded <- round((aoi8$julian/365)*52)*7

# All Okavango Swamp
all2$ndvi_nans <- as.numeric(as.character(all2$ndvi))
all2$ndvi_range <- ifelse(all2$ndvi_nans>0.05,all2$ndvi_nans,NA)
## Convert the dates to an R readable format
all2$asdate <- as.Date(all2$date, format = "%b %d, %Y")
all2$julian <- yday(all2$asdate)
all2$julian_rounded <- round((all2$julian/365)*52)*7
```

# Okavango Shrubland
## Calculate the loess smoothed mean NDVI for each Julian date
## Calculate EMSI for the record of each EOS.

```{r message=FALSE, warning=FALSE}
# Predict the Julian date average of Landsat 5 NDVI using a Loess function
mean_loess_shrubland_l5 <- predict(loess(ndvi_range ~ julian_rounded, aoi1), aoi1$julian_rounded)

# Calculate mean NDVI for each 16-day Julian period
ndvi_mean_shrubland_l5 <- setNames(aggregate(aoi1$ndvi_range, list(aoi1$julian_rounded), mean, na.rm=TRUE, na.action=NULL), c("julian", "ndvi_mean"))

# Calculate EMSI using Performance Analytics sd.multiperiod
aoi1$emsi = (aoi1$ndvi_range - mean_loess_shrubland_l5) /  sd.multiperiod(aoi1$ndvi_range,scale=1)

# Predict the Julian date average of Landsat 7 NDVI using a Loess function
mean_loess_shrubland_l7 <- predict(loess(ndvi_range ~ julian_rounded, aoi2), aoi2$julian_rounded)

# Calculate mean NDVI for each 16-day Julian period
ndvi_mean_shrubland_l7 <- setNames(aggregate(aoi2$ndvi_range, list(aoi2$julian_rounded), mean, na.rm=TRUE, na.action=NULL), c("julian", "ndvi_mean"))

# Calculate EMSI using Performance Analytics sd.multiperiod
aoi2$emsi = (aoi2$ndvi_range - mean_loess_shrubland_l7) /  sd.multiperiod(aoi2$ndvi_range,scale=1)

# Predict the Julian date average of Landsat 8 NDVI using a Loess function
mean_loess_shrubland_l8 <- predict(loess(ndvi_range ~ julian_rounded, aoi3), aoi3$julian_rounded)

# Calculate mean NDVI for each 16-day Julian period
ndvi_mean_shrubland_l8 <- setNames(aggregate(aoi3$ndvi_range, list(aoi3$julian_rounded), mean, na.rm=TRUE, na.action=NULL), c("julian", "ndvi_mean"))

# Calculate emsi using Performance Analytics sd.multiperiod
aoi3$emsi = (aoi3$ndvi_range - mean_loess_shrubland_l8) /  sd.multiperiod(aoi3$ndvi_range,scale=1)

# Predict the Julian date average of Sentinel-2 NDVI using a Loess function
mean_loess_shrubland_s2 <- predict(loess(ndvi_range ~ julian_rounded, aoi4), aoi4$julian_rounded)

# Calculate mean NDVI for each 16-day Julian period
ndvi_mean_shrubland_s2 <- setNames(aggregate(aoi4$ndvi_range, list(aoi4$julian_rounded), mean, na.rm=TRUE, na.action=NULL), c("julian", "ndvi_mean"))

# Calculate emsi using Performance Analytics sd.multiperiod
aoi4$emsi = (aoi4$ndvi_range - mean_loess_shrubland_s2) /  sd.multiperiod(aoi4$ndvi_range,scale=1)

# Predict the Julian date average of Sentinel-2 NDVI using a Loess function
mean_loess_shrubland_all1 <- predict(loess(ndvi_range ~ julian_rounded, all1), all1$julian_rounded)

# Calculate mean NDVI for each 16-day Julian period
ndvi_mean_shrubland_all1 <- setNames(aggregate(all1$ndvi_range, list(all1$julian_rounded), mean, na.rm=TRUE, na.action=NULL), c("julian", "ndvi_mean"))

# Calculate emsi using Performance Analytics sd.multiperiod
all1$emsi = (all1$ndvi_range - mean_loess_shrubland_all1) /  sd.multiperiod(all1$ndvi_range,scale=1)
```

# Okavango Swamp
## Calculate the loess smoothed mean NDVI for each Julian date
## Calculate EMSI for the record of each EOS.

```{r message=FALSE, warning=FALSE}
# Predict the Julian date average of Landsat 5 NDVI using a Loess function
mean_loess_swamp_l5 <- predict(loess(ndvi_range ~ julian_rounded, aoi5), aoi5$julian_rounded)

# Calculate mean NDVI for each 16-day Julian period
ndvi_mean_swamp_l5 <- setNames(aggregate(aoi5$ndvi_range, list(aoi5$julian_rounded), mean, na.rm=TRUE, na.action=NULL), c("julian", "ndvi_mean"))

# Calculate EMSI using Performance Analytics sd.multiperiod
aoi5$emsi = (aoi5$ndvi_range - mean_loess_swamp_l5) / sd.multiperiod(aoi5$ndvi_range,scale=1)

# Predict the Julian date average of Landsat 7 NDVI using a Loess function
mean_loess_swamp_l7 <- predict(loess(ndvi_range ~ julian_rounded, aoi6), aoi6$julian_rounded)

# Calculate mean NDVI for each 16-day Julian period
ndvi_mean_swamp_l7 <- setNames(aggregate(aoi6$ndvi_range, list(aoi6$julian_rounded), mean, na.rm=TRUE, na.action=NULL), c("julian", "ndvi_mean"))

# Calculate EMSI using Performance Analytics sd.multiperiod
aoi6$emsi = (aoi6$ndvi_range - mean_loess_swamp_l7) / sd.multiperiod(aoi6$ndvi_range,scale=1)

# Predict the Julian date average of Landsat 8 NDVI using a Loess function
mean_loess_swamp_l8 <- predict(loess(ndvi_range ~ julian_rounded, aoi7), aoi7$julian_rounded)

# Calculate mean NDVI for each 16-day Julian period
ndvi_mean_swamp_l8 <- setNames(aggregate(aoi7$ndvi_range, list(aoi7$julian_rounded), mean, na.rm=TRUE, na.action=NULL), c("julian", "ndvi_mean"))

# Calculate emsi using Performance Analytics sd.multiperiod
aoi7$emsi = (aoi7$ndvi_range - mean_loess_swamp_l8) / sd.multiperiod(aoi7$ndvi_range,scale=1)

# Predict the Julian date average of Sentinel-2 NDVI using a Loess function
mean_loess_swamp_s2 <- predict(loess(ndvi_range ~ julian_rounded, aoi8), aoi8$julian_rounded)
# Calculate mean NDVI for each 16-day Julian period
ndvi_mean_swamp_s2 <- setNames(aggregate(aoi8$ndvi_range, list(aoi8$julian_rounded), mean, na.rm=TRUE, na.action=NULL), c("julian", "ndvi_mean"))

# Calculate emsi using Performance Analytics sd.multiperiod
aoi8$emsi = (aoi8$ndvi_range - mean_loess_swamp_s2) /  sd.multiperiod(aoi8$ndvi_range,scale=1)

# Predict the Julian date average of Sentinel-2 NDVI using a Loess function
mean_loess_swamp_all2 <- predict(loess(ndvi_range ~ julian_rounded, all2), all2$julian_rounded)

# Calculate mean NDVI for each 16-day Julian period
ndvi_mean_swamp_all2 <- setNames(aggregate(all2$ndvi_range, list(all2$julian_rounded), mean, na.rm=TRUE, na.action=NULL), c("julian", "ndvi_mean"))

# Calculate emsi using Performance Analytics sd.multiperiod
all2$emsi = (all2$ndvi_range - mean_loess_swamp_all2) /  sd.multiperiod(all1$ndvi_range,scale=1)
```

# Plot Histograms

Histograms show the frequency of scences that are available to derive mean values.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Histograms of the three time series
hist(aoi1$julian_rounded,breaks=52,xlab="Julian day of year", main = "Landsat 5 Histogram of Dates in Shrubland")
hist(aoi2$julian_rounded,breaks=52,xlab="Julian day of year", main = "Landsat 7 Histogram of Dates in Shrubland")
hist(aoi3$julian_rounded,breaks=52,xlab="Julian day of year", main = "Landsat 8 Histogram of Dates in Shrubland")
hist(aoi4$julian_rounded,breaks=52,xlab="Julian day of year", main = "Sentinel-2 Histogram of Dates in Shrubland")

hist(aoi5$julian_rounded,breaks=52,xlab="Julian day of year", main = "Landsat 5 Histogram of Dates in Swamp")
hist(aoi6$julian_rounded,breaks=52,xlab="Julian day of year", main = "Landsat 7 Histogram of Dates in Swamp")
hist(aoi7$julian_rounded,breaks=52,xlab="Julian day of year", main = "Landsat 8 Histogram of Dates in Swamp")
hist(aoi8$julian_rounded,breaks=52,xlab="Julian day of year", main = "Sentinel-2 Histogram of Dates in Swamp")

hist(all1$julian_rounded,breaks=52,xlab="Julian day of year", main = "All Histogram of Dates in Shrubland")
hist(all2$julian_rounded,breaks=52,xlab="Julian day of year", main = "All Histogram of Dates in Swamp")
```

# Plot Time Series together

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plot time series together
shrubland_l5 = aoi1[!is.na(aoi1$ndvi_range),]
shrubland_l7 = aoi2[!is.na(aoi2$ndvi_range),]
shrubland_l8 = aoi3[!is.na(aoi3$ndvi_range),]
shrubland_s2 = aoi4[!is.na(aoi4$ndvi_range),]

swamp_l5 = aoi5[!is.na(aoi5$ndvi_range),]
swamp_l7 = aoi6[!is.na(aoi6$ndvi_range),]
swamp_l8 = aoi7[!is.na(aoi7$ndvi_range),]
swamp_s2 = aoi8[!is.na(aoi8$ndvi_range),]

plot_ndvi <- ggplot() +
  geom_point(data = shrubland_l5, aes(x=julian,y=ndvi_range), size = 0.1, color = "red") + 
  geom_line(data=ndvi_mean_shrubland_l5, aes(x=julian,y=ndvi_mean), color = "red") +
  geom_point(data = shrubland_l7, aes(x=julian,y=ndvi_range), size = 0.1, color = "green") +
  geom_line(data=ndvi_mean_shrubland_l7, aes(x=julian,y=ndvi_mean), color = "green") +
  geom_point(data = shrubland_l8, aes(x=julian,y=ndvi_range), size = 0.1, color = "blue") + 
  geom_line(data=ndvi_mean_shrubland_l8, aes(x=julian,y=ndvi_mean), color = "blue") +
  geom_point(data = shrubland_s2, aes(x=julian,y=ndvi_range), size = 0.1, color = "orange") + 
  geom_line(data=ndvi_mean_shrubland_s2, aes(x=julian,y=ndvi_mean), color = "orange") +
  geom_point(data = swamp_l5, aes(x=julian,y=ndvi_range), size = 0.3, color = "red") + 
  geom_line(data=ndvi_mean_swamp_l5, aes(x=julian,y=ndvi_mean), color = "red", linetype="dotted") +
  geom_point(data = swamp_l7, aes(x=julian,y=ndvi_range), size = 0.3, color = "green") +
  geom_line(data=ndvi_mean_swamp_l7, aes(x=julian,y=ndvi_mean), color = "green", linetype="dotted") +
  geom_point(data = swamp_l8, aes(x=julian,y=ndvi_range), size = 0.3, color = "blue") +  
  geom_line(data=ndvi_mean_swamp_l8, aes(x=julian,y=ndvi_mean), color = "blue", linetype="dotted") +
  geom_point(data = swamp_s2, aes(x=julian,y=ndvi_range), size = 0.3, color = "orange") + 
  geom_line(data=ndvi_mean_swamp_s2, aes(x=julian,y=ndvi_mean), color = "orange", linetype="dotted") +
  ggtitle("Okavango Shrubland & Swamp NDVI for Landsats 5,7,8 & Sentinel-2") + 
  xlab("Julian Day") + ylab("NDVI")

plot_ndvi <- plot_ndvi + theme(
    line = element_line(colour = "black"),
    title = element_text(colour = "black"),
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg
    legend.box.background = element_rect(fill = "transparent"),
    legend.title = element_text(colour = "black"),
    legend.text = element_text(colour = "black"),
    axis.text = element_text(colour = "black"),
    axis.ticks = element_line(colour = "black"),
    panel.background = element_rect(fill = "transparent",colour = NA), # or theme_blank()
    panel.grid.minor = element_line(colour = "black"), 
    panel.grid.major = element_blank(),
    plot.background = element_rect(fill = "transparent",colour = NA)
)

plot(plot_ndvi)
ggsave('~/Documents/emsi_okavango_shrubland_swamp_ndvi_mean.png', width = 8, height = 4.5, dpi = 300, bg = "transparent")

ggplotly(plot_ndvi)

```


```{r echo=FALSE, message=FALSE, warning=FALSE}
l5_shrubland_range_dates = aoi1[1:191,]
l7_shrubland_range_dates = aoi2[1:217,]
l8_shrubland_range_dates = aoi3[1:113,]
s2_shrubland_range_dates = aoi4[1:151,]
all1_shrubland_range_dates = all1[1:672,]

p4 <- ggplot(all1_shrubland_range_dates[!is.na(all1_shrubland_range_dates$emsi),], aes(x=asdate,y=emsi)) + 
  geom_point(aes(color=emsi)) + 
  scale_colour_gradient2(low = "red", mid = "green" , high = "blue", midpoint = 0.0) + 
  scale_y_continuous(limits = c(-1.3,1.3), breaks = seq(-1.3,1.3,0.5)) + 
  ggtitle("Okavango Shrubland EMSI") + 
  xlab("Date") + 
  ylab("EMSI") + 
  geom_line(size = 0.1) 

p4 <- p4 + theme(
    line = element_line(colour = "black"),
    title = element_text(colour = "black"),
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg
    legend.box.background = element_rect(fill = "transparent"),
    legend.title = element_text(colour = "black"),
    legend.text = element_text(colour = "black"),
    axis.text = element_text(colour = "black"),
    axis.ticks = element_line(colour = "black"),
    panel.background = element_rect(fill = "transparent",colour = NA), # or theme_blank()
    panel.grid.minor = element_line(colour = "black"), 
    panel.grid.major = element_blank(),
    plot.background = element_rect(fill = "transparent",colour = NA)
)

plot(p4)
ggsave('~/Documents/okavango_shrubland_landsat578s2_emsi.png', width = 8, height = 4.5, dpi = 300, bg = "transparent")

ggplotly(p4)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
l5_swamp_range_dates = aoi5[1:191,]
l7_swamp_range_dates = aoi6[1:217,]
l8_swamp_range_dates = aoi7[1:113,]
s2_swamp_range_dates = aoi8[1:150,]
all2_swamp_range_dates = all2[1:671,]

p4 <- ggplot(all2_swamp_range_dates[!is.na(all2_swamp_range_dates$emsi),], aes(x=asdate,y=emsi)) + 
  geom_point(aes(color=emsi)) + 
  scale_colour_gradient2(low = "red", mid = "green" , high = "blue", midpoint = 0.0) + 
  scale_y_continuous(limits = c(-1.3,1.3), breaks = seq(-1.3,1.3,0.5)) + 
  ggtitle("Okavango Swamp EMSI") + 
  xlab("Date") + 
  ylab("EMSI") + 
  geom_line(size = 0.1) 

p4 <- p4 + theme(
    line = element_line(colour = "black"),
    title = element_text(colour = "black"),
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg
    legend.box.background = element_rect(fill = "transparent"),
    legend.title = element_text(colour = "black"),
    legend.text = element_text(colour = "black"),
    axis.text = element_text(colour = "black"),
    axis.ticks = element_line(colour = "black"),
    panel.background = element_rect(fill = "transparent",colour = NA), # or theme_blank()
    panel.grid.minor = element_line(colour = "black"), 
    panel.grid.major = element_blank(),
    plot.background = element_rect(fill = "transparent",colour = NA)
)

plot(p4)
ggsave('~/Documents/okavango_swamp_landsat578s2_emsi.png', width = 8, height = 4.5, dpi = 300, bg = "transparent")

ggplotly(p4)
```

Alternately, I can plot the three time series together.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plot time series together
shrubland_l5 = aoi1[!is.na(aoi1$emsi),]
shrubland_l7 = aoi2[!is.na(aoi2$emsi),]
shrubland_l8 = aoi3[!is.na(aoi3$emsi),]
shrubland_s2 = aoi4[!is.na(aoi4$emsi),]
shrubland_all = all1[!is.na(all1$emsi),]

p5 <- ggplot() +
  geom_line(data = shrubland_l5, aes(x=asdate,y=emsi), size = 0.1, color = "red") + 
  geom_line(data = shrubland_l7, aes(x=asdate,y=emsi), size = 0.1, color = "green") +
  geom_line(data = shrubland_l8, aes(x=asdate,y=emsi), size = 0.1, color = "blue") + 
  geom_line(data = shrubland_s2, aes(x=asdate,y=emsi), size = 0.1, color = "orange") +
  geom_line(data = shrubland_all, aes(x=asdate,y=emsi), size = 0.1, color = "white") +
  scale_colour_gradient2(low = "red", mid = "green" , high = "blue", midpoint = 0.0) + 
  scale_y_continuous(limits = c(-1.3,1.3), breaks = seq(-1.3,1.3,0.5)) + 
  ggtitle("Okavango Shrubland EMSI of Landsat 5,7,8 & Sentinel-2") + 
  xlab("Calendar Date") + ylab("EMSI")

ggplotly(p5)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plot time series together
swamp_l5 = aoi5[!is.na(aoi5$emsi),]
swamp_l7 = aoi6[!is.na(aoi6$emsi),]
swamp_l8 = aoi7[!is.na(aoi7$emsi),]
swamp_s2 = aoi8[!is.na(aoi8$emsi),]
swamp_all = all2[!is.na(all2$emsi),]

p5 <- ggplot() +
  geom_line(data = swamp_l5, aes(x=asdate,y=emsi), size = 0.1, color = "red") + 
  geom_line(data = swamp_l7, aes(x=asdate,y=emsi), size = 0.1, color = "green") +
  geom_line(data = swamp_l8, aes(x=asdate,y=emsi), size = 0.1, color = "blue") + 
  geom_line(data = swamp_s2, aes(x=asdate,y=emsi), size = 0.1, color = "orange") +
  geom_line(data = swamp_all, aes(x=asdate,y=emsi), size = 0.1, color = "white") +
  scale_colour_gradient2(low = "red", mid = "green" , high = "blue", midpoint = 0.0) + 
  scale_y_continuous(limits = c(-1.3,1.3), breaks = seq(-1.3,1.3,0.5)) + 
  ggtitle("Okavango Swamp EMSI of Landsat 5,7,8 & Sentinel-2") + 
  xlab("Calendar Date") + ylab("EMSI")

ggplotly(p5)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}

# Plot time series together
l5 = aoi1[!is.na(aoi1$ndvi_range),]
l7 = aoi2[!is.na(aoi2$ndvi_range),]
l8 = aoi3[!is.na(aoi3$ndvi_range),]
s2 = aoi4[!is.na(aoi4$ndvi_range),]
all = all1[!is.na(all1$ndvi_range),]

p3 <- ggplot() +
  geom_point(data = l5, aes(x=julian,y=ndvi_range), size = 0.2, color = "red") + 
  geom_smooth(data = l5, aes(x=julian,y=ndvi_range), method="loess", se = FALSE, na.rm = FALSE, span = 0.5, color = "red", size=0.5) +
  geom_point(data = l7, aes(x=julian,y=ndvi_range), size = 0.2, color = "green") +
  geom_smooth(data = l7, aes(x=julian,y=ndvi_range), method="loess", se = FALSE, na.rm = FALSE, span = 0.5, color = "green", size=0.5) +
  geom_point(data = l8, aes(x=julian,y=ndvi_range), size = 0.2, color = "blue") +
  geom_smooth(data = l8, aes(x=julian,y=ndvi_range), method="loess", se = FALSE, na.rm = FALSE, span = 0.5, color = "blue", size=0.5) +
  geom_point(data = s2, aes(x=julian,y=ndvi_range), size = 0.2, color = "orange") +
  geom_smooth(data = s2, aes(x=julian,y=ndvi_range), method="loess", se = FALSE, na.rm = FALSE, span = 0.5, color = "orange", size=0.5) +
  geom_smooth(data = all, aes(x=julian,y=ndvi_range), method="loess", se = FALSE, na.rm = FALSE, span = 0.5, color = "white", size=0.5) +
  ggtitle("NDVI Okavango Shrubland") + 
  xlab("Julian Day") + ylab("NDVI")

p3 <- p3 + theme(
    line = element_line(colour = "blue"),
    title = element_text(colour = "blue"),
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg
    legend.box.background = element_rect(fill = "transparent"),
    legend.title = element_text(colour = "blue"),
    legend.text = element_text(colour = "blue"),
    axis.text = element_text(colour = "blue"),
    axis.ticks = element_line(colour = "blue"),
    panel.background = element_rect(fill = "transparent",colour = NA), # or theme_blank()
    panel.grid.minor = element_line(colour = "blue"), 
    panel.grid.major = element_blank(),
    plot.background = element_rect(fill = "black",colour = NA)
)

plot(p3)
ggsave('~/Documents/ndvi_okavango_shrubland.png', width = 8, height = 4.5, dpi = 300, bg = "transparent")

ggplotly(p3)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}

# Plot time series together
l5 = aoi5[!is.na(aoi5$ndvi_range),]
l7 = aoi6[!is.na(aoi6$ndvi_range),]
l8 = aoi7[!is.na(aoi7$ndvi_range),]
s2 = aoi8[!is.na(aoi8$ndvi_range),]
all = all2[!is.na(all2$ndvi_range),]

p3 <- ggplot() +
  geom_point(data = l5, aes(x=julian,y=ndvi_range), size = 0.2, color = "red") + 
  geom_line(data=l5, aes(x=julian,y=ndvi_range), size = 0.1, color = "red") +
  geom_point(data = l7, aes(x=julian,y=ndvi_range), size = 0.2, color = "green") +
  geom_line(data= l7, aes(x=julian,y=ndvi_range), size = 0.1, color = "green") +
  geom_point(data = l8, aes(x=julian,y=ndvi_range), size = 0.2, color = "blue") +
  geom_line(data= l8, aes(x=julian,y=ndvi_range), size = 0.1, color = "blue") +
  geom_point(data = s2, aes(x=julian,y=ndvi_range), size = 0.2, color = "orange") +
  geom_line(data= s2, aes(x=julian,y=ndvi_range), size = 0.1, color = "orange") +
  ggtitle("NDVI Okavango Swamp") + 
  xlab("Julian Day") + ylab("NDVI")

p3 <- p3 + theme(
    line = element_line(colour = "blue"),
    title = element_text(colour = "blue"),
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg
    legend.box.background = element_rect(fill = "transparent"),
    legend.title = element_text(colour = "blue"),
    legend.text = element_text(colour = "blue"),
    axis.text = element_text(colour = "blue"),
    axis.ticks = element_line(colour = "blue"),
    panel.background = element_rect(fill = "transparent",colour = NA), # or theme_blank()
    panel.grid.minor = element_line(colour = "blue"), 
    panel.grid.major = element_blank(),
    plot.background = element_rect(fill = "black",colour = NA)
)

plot(p3)
ggsave('~/Documents/ndvi_okavango_swanp.png', width = 8, height = 4.5, dpi = 300, bg = "transparent")

ggplotly(p3)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plot time series
l5 = aoi1[!is.na(aoi1$emsi),]
l7 = aoi2[!is.na(aoi2$emsi),]
l8 = aoi3[!is.na(aoi3$emsi),]
s2 = aoi4[!is.na(aoi4$emsi),]
shrub_all = all1[!is.na(all1$emsi),]


p2 <- ggplot(shrub_all, aes(x=asdate,y=emsi)) +
  geom_point(aes(color=emsi), size=0.5) + 
  scale_colour_gradient2(low = "red", mid = "green", high = "blue", midpoint = 0.0) +
  scale_y_continuous(limits = c(-3,1.3), breaks = seq(-2,1.3,0.5)) +
  geom_smooth(data = shrub_all, method="loess", se = FALSE, na.rm = FALSE, span = 0.1, color = "white", size=0.5) +
  geom_line(data = shrub_all, aes(x=asdate,y=emsi), size = 0.1, color = "white") +
  ggtitle("Okavango Shrubland") + 
  xlab("Calendar Date") + ylab("EMSI")

p5 <- p2 + theme(
    line = element_line(colour = "white"),
    title = element_text(colour = "white"),
    legend.background = element_rect(fill = "black"), # get rid of legend bg
    legend.box.background = element_rect(fill = "black"),
    legend.title = element_text(colour = "white"),
    legend.text = element_text(colour = "white"),
    axis.text = element_text(colour = "white"),
    axis.ticks = element_line(colour = "white"),
    panel.background = element_rect(fill = "black",colour = NA), # or theme_blank()
    panel.grid.minor = element_line(colour = "white"), 
    panel.grid.major = element_blank(),
    plot.background = element_rect(fill = "black",colour = NA)
)

plot(p5)
ggplotly(p5)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plot time series
l5 = aoi5[!is.na(aoi5$emsi),]
l7 = aoi6[!is.na(aoi6$emsi),]
l8 = aoi7[!is.na(aoi7$emsi),]
s2 = aoi8[!is.na(aoi8$emsi),]
swamp_all = all2[!is.na(all2$emsi),]


p2 <- ggplot(swamp_all, aes(x=asdate,y=emsi)) +
  geom_point(aes(color=emsi), size=0.5) + 
  scale_colour_gradient2(low = "red", mid = "green", high = "blue", midpoint = 0.0) +
  scale_y_continuous(limits = c(-3,1.3), breaks = seq(-2,1.3,0.5)) +
  geom_smooth(data = swamp_all, method="loess", se = FALSE, na.rm = FALSE, span = 0.1, color = "white", size=0.5) +
  geom_line(data = swamp_all, aes(x=asdate,y=emsi), size = 0.1, color = "white") +
  ggtitle("Okavango Swamp") + 
  xlab("Calendar Date") + ylab("EMSI")

p5 <- p2 + theme(
    line = element_line(colour = "white"),
    title = element_text(colour = "white"),
    legend.background = element_rect(fill = "black"), # get rid of legend bg
    legend.box.background = element_rect(fill = "black"),
    legend.title = element_text(colour = "white"),
    legend.text = element_text(colour = "white"),
    axis.text = element_text(colour = "white"),
    axis.ticks = element_line(colour = "white"),
    panel.background = element_rect(fill = "black",colour = NA), # or theme_blank()
    panel.grid.minor = element_line(colour = "white"), 
    panel.grid.major = element_blank(),
    plot.background = element_rect(fill = "black",colour = NA)
)

plot(p5)
ggplotly(p5)
```
